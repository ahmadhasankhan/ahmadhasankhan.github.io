Using Angular With Rails
====================

In one of the Rails application we decided to use **AngularJS** as front-end and **ROR (RubyOnRails)** as back-end ([Why Angular?](http://www.sitepoint.com/10-reasons-use-angularjs/)) , I faced some problem in integrating Angular with Rails and I think most of the developers face issues in integration, because currently there is no **Rails Way** for managing the front-end assets needed to create a [rich JavaScript](http://en.wikipedia.org/wiki/List_of_rich_Internet_application_frameworks) application using AngularJS.
Rails wasn't designed with a JavaScript framework like AngularJS in mind. Rails view is good enough to serve up pages. Rich Javascript-based single-page applications are not something Rails encourages.

In this Tutorial i am going to show you how to integrate Angular with Rails and how they work together.

> **Note:** I am assuming readers have basic knowledge of ROR and AngularJS, If you're completely new, you may not be able to understand some parts, but you should still be able to follow along as i will show a demo app here.

Goal
------
Create an application which will use *AngularJS* In front-end and Rails In Back-end.

Main Features
--------------------
- **Add Product:** You can add a new product.
- **List Products:** You can see the list of products.
- **Show Product:** You can view the full details of the product.
- **Edit Product:** You can edit a particular product on click.
- **Delete product:** You would be able to delete product.

Tools
-------
- Ruby ~> 2.0 or later
- Rails ~> 4.0.x
- Postgresql or MySQL

Project Setup
--------------
```sh
$ rails new rails_with_angular -d=postgresql -T
```
> **Tip:** Remove "-d=postgresql" option if you want to use default sqlite database and "-T" option is for tests generated by Rails.

Open your Gemfile and add these lines
```sh
gem 'angularjs-rails'
gem 'twitter-bootstrap-rails'
```
> **Tip:** You can also [download](https://angularjs.org/) and use AngularJS library by putting in Rails assets folder if you don't wish to use angularjs-rails gem.

Install Gems and create database
```sh
$ bundle install
$ rake db:create
```
After running ``bundle install`` run the generator:

```sh
$ rails generate bootstrap:install static
```

Start the Rails server
```sh
$ rails s
```
Go to **[localhost:3000](localhost:3000)** and you will find Rails welcome page "welcome to Rails"

Create a home page.
```sh
$ rails generate controller home index
```

Change the default Rails welcome page to our homepage.

config/routes.rb
```sh
# Add the following line at bottom of routes.rb

root 'home#index'
```
Generate a **CRUD**(*create, read, update and destroy*) for product
```sh
$ rails generate scaffold Product name:string price:decimal description:text image_url:string
$ rake db:migrate
```

Include Angular Libraries
------------------------
Now we want to tell our application to include the AngularJS files, and we want to make sure it gets loaded before other files that depends on it.

> **Note:** Note: Angular and Turbolinks can conflict with one another, so you can disable Turbolinks if any issue arises.

```sh
<!-- app/assets/javascripts/application.js -->

// Add the following lines

//= require angular
//= require angular-route
//= require angular-resource
```
After adding required files the application.js file should looks like this

```
//= require angular
//= require angular-route
//= require angular-resource
//= require jquery
//= require jquery_ujs
//= require twitter/bootstrap
//= require turbolinks
//= require_tree .
```


Setting up the layout
----------------------
We'll add ng-app and ng-view tag in our layout, which signals that we have an Angular app in our page.


#### <i class="icon-file"></i> Create a new layout file for angular

```sh
<!-- app/views/layouts/angular.html.erb -->

<!DOCTYPE html>
<html lang="en" ng-app="RailsWithAngular">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title><%= content_for?(:title) ? yield(:title) : "AngularWithRails" %></title>
	<%= csrf_meta_tags %>

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.1/html5shiv.js" type="text/javascript"></script>
	<![endif]-->

	<%= stylesheet_link_tag "application", :media => "all" %>
	<%= javascript_include_tag "application" %>
</head>
<body>
<div class="navbar navbar-default navbar-static-top">
	<div class="container">
		<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
		</button>
		<a class="navbar-brand" href="#">Angular With Rails</a>
		<a href="https://github.com/ahmadhasankhan/rails_with_angular/">
			<img style="position: absolute; top: 0; right: 0; border: 0;" src="https://github-camo.global.ssl.fastly.net/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

		<div class="navbar-collapse collapse navbar-responsive-collapse">
			<ul class="nav navbar-nav">
				<li><%= link_to "Home", "/" %></li>
				<li><%= link_to "Products", "/#/products" %></li>
				<li><%= link_to "Add New", "/#/products/new" %></li>
			</ul>
		</div>
	</div>
</div>

<div class="container">

	<div class="row">
		<div class="col-lg-9">
			<%= bootstrap_flash %>
			<div ng-view></div>
		</div>
		<div class="col-lg-3">
			<div class="well sidebar-nav">
				<h3>Sidebar</h3>
				<ul class="nav nav-list">
					<li><%= link_to "Link1", "/path1" %></li>
					<li><%= link_to "Link2", "/path2" %></li>
					<li><%= link_to "Link3", "/path3" %></li>
				</ul>
			</div>
			<!--/.well -->
		</div>
		<!--/span-->
	</div>
	<!--/row-->

	<footer>
		<p>&copy; For You 2014</p>
	</footer>

</div>
<!-- /container -->
<%= javascript_include_tag "application" %>
</body>
</html>


```
> **Note:** You can also use "application.html.erb". Just to make it separate i have created a new layout for Angular.

Since we have created a new layout for angular, we have to tell the controller to use angular layout by adding angular layout in HomeController

```sh
<!-- app/controllers/home_controller.rb -->
class HomeController < ApplicationController
respond_to :html
layout "angular"

def index
end
end
```

When the very first time we request to our server then the request would be handled by Rails HomeController's index action and because we have set our app root to '*home#index*' path, the index action will finally respond to angular layout and inside the angular layout we have two main tags of Angular that is  `ng-app` and `ng-view` .
**ng-app** initialize the angular application and this allows Angular to handle the routing instead of Rails. **ng-view** is where angular will dump it's templates.


Set CSRF cookie for ng
-----------------------

Since only JavaScript that runs on your domain could read the cookie, your server can be assured that the XHR came from JavaScript running on your domain.

To take advantage of this (CSRF Protection), your server needs to set a token in a JavaScript readable session cookie called XSRF-TOKEN on first HTTP GET request. On subsequent non-GET requests the server can verify that the cookie matches X-XSRF-TOKEN HTTP header

```sh
class ApplicationController < ActionController::Base
# Prevent CSRF attacks by raising an exception.
# For APIs, you may want to use :null_session instead.
protect_from_forgery with: :exception

after_filter  :set_csrf_cookie_for_ng

def set_csrf_cookie_for_ng
cookies['XSRF-TOKEN'] = form_authenticity_token if protect_against_forgery?
end

protected

def verified_request?
super || form_authenticity_token == request.headers['X-XSRF-TOKEN']
end
end

```
For details go to AngularJS official [website](https://docs.angularjs.org/api/ng/service/$http#cross-site-request-forgery-xsrf-protection)

Creating Angular files
----------------------------
Now it's time to work on front-end side.
Let's create a directory for our angular routes, controllers and resources. You can name it whatever you want.
```sh
$ mkdir -p app/assets/javascripts/angular
```
Now let's create the route, controller and resources. I'm calling controller as "products controller," and the convention in Angular is to append your controller filenames with Ctrl. Thus our filename will be app/assets/javascripts/angular/productsCtrl.js.coffee,
I am putting all the routes inside the app/assets/javascripts/angular/app.js
and all the Factory in app/assets/javascripts/angular/resources.js
*But you can name it whatever you want*

Creating Angular routes
----------------------------
First we'll add a routing directive in order to make our products#index to be our "default page." Here I'm defining my routing in app/assets/javascripts/angular/app.js. but again I don't think the filename matters.

```sh
var myApp = angular.module('RailsWithAngular', ['ngRoute', 'ngResource']);

//Routes

myApp.config([
'$routeProvider', '$locationProvider', function ($routeProvider, $locationProvider) {
$routeProvider.when('/products', {
templateUrl: '/template/products/index.html',
controller: 'ProductListCtr'
});
$routeProvider.when('/products/new', {
templateUrl: '/template/products/new.html',
controller: 'ProductAddCtr'
});
$routeProvider.when('/products/:id/edit', {
templateUrl: '/template/products/edit.html',
controller: "ProductUpdateCtr"
});
$routeProvider.when('/products/:id', {
templateUrl: '/template/products/show.html',
controller: "ProductShowCtr"
});
$routeProvider.otherwise({
redirectTo: '/products'
});
}
]);

```
Creating product controller
----------------------------
Now we will create a new file productsCtrl.js." Here I'm going to put all the crud action, just think same as rails.

```sh
//Controller
myApp.controller("ProductListCtr", ['$scope', '$http', '$resource', 'Products', 'Product', '$location', function ($scope, $http, $resource, Products, Product, $location) {

$scope.products = Products.query();

$scope.deleteProduct = function (ProductId) {
if (confirm("Are you sure you want to delete this Product?")) {
Product.delete({ id: ProductId }, function () {
$scope.products = Products.query();
$location.path('/');
});
}
};
}]);

myApp.controller("ProductUpdateCtr", ['$scope', '$resource', 'Product', '$location', '$routeParams', function ($scope, $resource, Product, $location, $routeParams) {
$scope.product = Product.get({id: $routeParams.id});
$scope.update = function () {
if ($scope.productForm.$valid) {
Product.update({id: $scope.product.id}, {product: $scope.product}, function () {
$location.path('/');
}, function (error) {
console.log(error)
});
}
};
}]);

myApp.controller("ProductShowCtr", ['$scope', '$resource', 'Product', '$location', '$routeParams', function ($scope, $resource, Product, $location, $routeParams) {
$scope.product = Product.get({id: $routeParams.id});

}]);

myApp.controller("ProductAddCtr", ['$scope', '$resource', 'Products', '$location', function ($scope, $resource, Products, $location) {

$scope.product = {name: '', price: '', description: '', image_url: '' };
$scope.save = function () {
if ($scope.productForm.$valid) {
Products.create({product: $scope.product}, function () {
$location.path('/');
}, function (error) {
console.log(error)
});
}
}
}]);

```

Create Resources
----------------------------
A factory which creates a resource object that lets you interact with RESTful server-side data sources.
The returned resource object has action methods which provide high-level behaviors without the need to interact with the low level $http service.

Requires the ngResource module.

You can read more about Resource [here](https://docs.angularjs.org/api/ngResource/service/$resource)

```sh
<!-- app/assets/javascripts/angular/resources.js -->

//Factory
myApp.factory('Products', ['$resource', function ($resource) {
return $resource('/products.json', {}, {
query: { method: 'GET', isArray: true },
create: { method: 'POST' }
})
}]);

myApp.factory('Product', ['$resource', function ($resource) {
return $resource('/products/:id.json', {}, {
show: { method: 'GET' },
update: { method: 'PUT', params: {id: '@id'} },
delete: { method: 'DELETE', params: {id: '@id'} }
});
}]);

```


Add Angular template folder
----------------------------------
We'll also want a place to keep our Angular templates. I decided to put mine in public/template. Again, you can place them wherever you like.

```sh
mkdir public/template
```

I am going to follow something like rails directory structure, so i will be creating a separate folder for products, Thus our products folder path will  be public/template/products
```sh
mkdir -p public/template/products
```
<i class="icon-file">index.html</i>
```sh
<!-- public/template/products/index.html -->
<div class="row">
	<div class="panel panel-primary">
		<!-- Default panel contents -->
		<div class="panel-heading">Products<a class="label label-primary pull-right" href="#/products/new">Create a
			product</a></div>
		<!-- Table -->
		<table class="table table-hover">
			<tr>
				<th>Name</th>
				<th>Price</th>
				<th>Description</th>
				<th>Action</th>
			</tr>
			<tr ng-hide="products.length">
				<td colspan="5">No Product found, Please create one.</td>
			</tr>
			<tr ng-show="products.length" ng-repeat="product in products">
				<td><a href="#/products/{{product.id}}">{{product.name}}</a></td>
				<td>{{product.price}}</td>
				<td>{{product.description}}</td>
				<td>
					<a href="#/products/{{product.id}}/edit"><i class="fa fa-pencil-square-o"></i></a> | <a href=""
																											ng-click="deleteProduct(product.id)"><i
						class="fa  fa-minus-circle "></i></a>
				</td>
			</tr>
		</table>
	</div>
</div>
```

<i class="icon-file">_form.html</i>
```sh
<!-- public/template/products/_form.html -->

<div class="input-group" ng-class="{'has-error' : submitted && productForm.name.$invalid}">
	<span class="input-group-addon"><label style="width: 70px">*Name</label></span>
	<input type="text" name="name" class="form-control" ng-model="product.name" required placeholder="Product Name"/>
</div>
<p ng-show=" submitted && productForm.name.$invalid" class="help-block">Name is required.</p>
</br>
<div class="input-group" ng-class="{'has-error' : submitted && productForm.price.$invalid}">
	<span class="input-group-addon"><label style="width: 70px">*Price </label> </span>
	<input type="number" name="price" class="form-control" ng-model="product.price" required placeholder="999.XX"/>
</div>
<p ng-show="submitted && productForm.price.$error.required" class="help-block">Price is required.</p>

</br>
<div class="input-group">
	<span class="input-group-addon"><label style="width: 70px">ImageURL</label> </span>
	<input type="text" name="image_url" class="form-control" ng-model="product.image_url"
		   placeholder="Image URL" />
</div>
</br>
<div class="input-group">
	<span class="input-group-addon"><label style="width: 67px">Description</label> </span>
    <textarea name="description" class="form-control" ng-model="product.description"
			  placeholder="description"></textarea>
</div>
</br>

<div class="input-group">
	<div class="pull-left">
		<a class="btn btn-default" href="/"> Back</a>
		<button type="submit" class="btn btn-primary" ng-click="submitted=true">Submit</button>
	</div>
</div>
```
<i class="icon-file">new.html</i>

```sh
<!-- public/template/products/new.html -->
<div class="row">
	<form class="tab-pane active form-horizontal" id="first" name="productForm" novalidate ng-submit="save()">
		<h3 class="block">Add a new product</h3>
		<div ng-include="'/template/products/_form.html'"></div>
	</form>
</div>

```

<i class="icon-file">edit.html</i>
```sh
<!-- public/template/products/edit.html -->
<div class="col-md-10">
	<form class="tab-pane active form-horizontal" id="first" name="productForm" novalidate ng-submit="update()">
		<h3 class="block">Edit product</h3>
		<div ng-include="'/template/products/_form.html'"></div>
	</form>
</div>
```

<i class="icon-file">show.html</i>
```sh
<!-- public/template/products/show.html -->
<div class="row">
	<div class="col-sm-6 col-md-4">
		<div class="thumbnail">
			<img src="{{product.image_url}}" alt="Product Image" width="300" height="300">
			<div class="caption">
				<h3>{{product.name}}</h3>
				Price: {{product.price}} $
				<p>{{product.description}}</p>
				<p><a ng-href="#/products" class="btn btn-primary" role="button">Back</a> <a href="#/products/{{product.id}}/edit" class="btn btn-default" role="button">Edit</a></p>
			</div>
		</div>
	</div>
</div>
```

Don't forget to run your server ```rails s```
Now, if you go to http://localhost:3000/  you should see the products index page.
After following this whole article, you should be able to add new product, edit product, delete product and show product.

You can improve your application by implementing authentication and putting some more logics.

>Fork working code from [Github](https://github.com/ahmadhasankhan/RailsWithAngular)
> Visit The Running [Application](https://railswithangular.herokuapp.com/)

